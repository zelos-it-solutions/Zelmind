{% extends 'home_page/base.html' %}
{% load static %}

{% block content %}
    <!-- Chat -->
    <section class="chat-panel">
      <div id="chat-box" class="chat-messages">
        {% for msg in messages %}
          <div class="message {% if msg.sender == "user" %}user-message{% else %}agent-message{% endif %}" data-sender="{{ msg.sender }}" {% if current_convo %}data-convo-id="{{ current_convo.id }}"{% endif %}>
            <div class="avatar {% if msg.sender == "user" %}user-avatar{% else %}agent-avatar{% endif %}">
              {% if msg.sender == "user" %}
                {% if request.user.first_name %}
                  {{ request.user.first_name|slice:":1"|upper }}
                {% else %}
                  {{ request.user.username|slice:":1"|upper }}
                {% endif %}
              {% else %}
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                  <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14 c0 1.1.9 2 2 2h14 c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM19 20H5V8h14v12z" fill="#5F6368"/>
                </svg>
              {% endif %}
            </div>
            <div class="message-content">
              {% if msg.message_type == 'event_success' %}
                <div class="create-event-box">
                   <div class="create-event-icon">
                      <img src="{% static 'home_page/images/google-calendar.png' %}" alt="Google Calendar" width="24" height="24">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                         <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM10 17L5 12L6.41 10.59L10 14.17L17.59 6.58L19 8L10 17Z" fill="#34A853"/>
                      </svg>
                   </div>
                   <div class="create-event-details">
                      <div class="create-event-title">{{ msg.content.event_title|default:'Your Event' }}</div>
                      <div class="create-event-subtitle success">Event created successfully</div>
                   </div>
                </div>
                {% if msg.text %}
                  <div class="bubble" style="margin-top: 8px;">
                    {{ msg.text|linebreaksbr }}
                  </div>
                {% endif %}
              {% elif msg.message_type == 'event_preview' %}
                {# Container for event preview card - JavaScript will hydrate this into an interactive card #}
                <div class="event-preview-card-container" 
                     data-event-content="{{ msg.content_json|escape }}"
                     data-convo-id="{% if current_convo %}{{ current_convo.id }}{% endif %}"
                     data-message-id="{{ msg.id }}">
                </div>
              {% elif msg.message_type == 'event_deletion_confirmation' %}
                 {# Container for deletion confirmation - JavaScript will hydrate this #}
                 <div class="event-deletion-card-container"
                      data-event-content="{{ msg.content_json|escape }}"
                      data-convo-id="{% if current_convo %}{{ current_convo.id }}{% endif %}"
                      data-message-id="{{ msg.id }}">
                 </div>
                 {% if msg.text %}
                    <div class="bubble" style="margin-top: 8px;">
                        {{ msg.text|linebreaksbr }}
                    </div>
                 {% endif %}
              {% elif msg.message_type == 'event_update_confirmation' %}
                 {# Container for update confirmation - JavaScript will hydrate this #}
                 <div class="event-update-card-container"
                      data-event-content="{{ msg.content_json|escape }}"
                      data-convo-id="{% if current_convo %}{{ current_convo.id }}{% endif %}"
                      data-message-id="{{ msg.id }}">
                 </div>
                 {% if msg.text %}
                    <div class="bubble" style="margin-top: 8px;">
                        {{ msg.text|linebreaksbr }}
                    </div>
                 {% endif %}
              {% elif msg.message_type == 'event_deleted' %}
                 {# Static HTML for deleted event card #}
                 <div style="background: #1e1e1e; border: 1px solid #333; border-radius: 12px; padding: 16px; color: #fff; display: flex; align-items: center; gap: 12px;">
                    <div style="background: #333; border-radius: 50%; padding: 8px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#aaa" stroke-width="2">
                            <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2-2v2" />
                        </svg>
                    </div>
                    <div style="font-weight: 600;">Event Deleted</div>
                </div>
                {% if msg.text %}
                    <div class="bubble" style="margin-top: 8px;">
                        {{ msg.text|linebreaksbr }}
                    </div>
                 {% endif %}
              {% elif msg.message_type == 'event_updated' %}
                 {# Static HTML for updated event card #}
                 <div style="background: #1e1e1e; border: 1px solid #333; border-radius: 12px; padding: 16px; color: #fff; display: flex; align-items: center; gap: 12px;">
                    <div style="background: #333; border-radius: 50%; padding: 8px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#4CAF50" stroke-width="2">
                            <path d="M20 6L9 17l-5-5" />
                        </svg>
                    </div>
                    <div style="font-weight: 600;">Event Updated</div>
                </div>
                {% if msg.text %}
                    <div class="bubble" style="margin-top: 8px;">
                        {{ msg.text|linebreaksbr }}
                    </div>
                 {% endif %}
              {% else %}
                {% if msg.text %}
                  <div class="bubble" {% if msg.sender == "agent" %}data-raw="{{ msg.text|escape }}"{% endif %} {% if is_new_conversation_page and forloop.first and msg.sender == "agent" %}data-welcome-message="true"{% endif %}>
                    {% if is_new_conversation_page and forloop.first and msg.sender == "agent" %}
                      {{ msg.text|escape }}
                    {% else %}
                      {{ msg.text|linebreaksbr }}
                    {% endif %}
                  </div>
                {% endif %}
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
      <form id="chat-form" method="post" action="{% url 'home_page:chat_process' %}"
            data-user-avatar="{{ request.user.first_name|slice:":1"|upper }}"
            data-agent-avatar='<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM19 20H5V8h14v12z" fill="#5F6368"/></svg>'
            {% if current_convo %}data-initial-convo-id="{{ current_convo.id }}"{% endif %}>
        {% csrf_token %}
        <div class="chat-input">
          <div class="chat-input-inner">
            <textarea id="chat-input" name="message" class="chat-textarea" placeholder="Enter message" rows="1"></textarea>
            <button type="button" id="send-button" class="send-btn">âž¤</button>
          </div>
        </div>
      </form>
    </section>
{% endblock %}